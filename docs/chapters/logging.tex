% !TeX root = ../arara-manual.tex
\chapter{Logging}
\label{chap:logging}

% TODO fix reference
A log file is a special type of file that records events that occur in a software run. \arara\ provides such feature through the \opbox{{-}log} command line option (Section~\ref{foo}, page~\pageref{foo}) or the equivalent key in the configuration file (Section~\ref{foo}, page~\pageref{foo}). This chapter covers the basic structure of a typical log file provided by our tool, including the important sections that can be used to identify potential issues. The following example is used to illustrate the logging feature:

\begin{ncodebox}{Source file}{teal}{\icnote}{white}{doc12.tex}
% arara: pdftex
% arara: clean: { extensions: [ log ] }
Hello world.
\bye
\end{ncodebox}

When running the tool on the previous example with the \opbox{{-}log} command line option (otherwise, the logging framework will not provide a file at all), we will obtain the expected \rbox{arara.log} log file containing the most significant events that happened during this particular execution, as well as details regarding the underlying operating system. Note that timestamps were deliberated removed from the log entries in order to declutter the output, and line breaks were included as to easily spot each entry,

\section{System information}
\label{sec:systeminformation}

The very first entry to appear in the log file is the current version of \arara\ followed by a revision number. The revision number acts as a counter for the last review on the major version. The counter starts at 1 to denote the first release in the version 4.0 series. The revision number is also important to indicate possible new features introduced later on in the application.

\begin{codebox}{Log file}{teal}{\icnote}{white}
Welcome to arara 4.0 (revision 1)!
\end{codebox}

The following entries in the log file are the absolute path of the current deployment of \arara\ (line 1), details about the current Java virtual machine (namely, vendor and absolute path, in lines 2 and 3, respectively), the underlying operating system information (namely, system name, architecture and eventually the kernel version, in line 4), home and working directories (lines 5 and 6, respectively), and the absolute path of the applied configuration file, if any (line 7). This section is very important to help tracking possible issues related to the underlying operating system and the tool configuration itself.

\begin{codebox}{Log file}{teal}{\icnote}{white}
::: arara @ /opt/paulo/arara
::: Java 1.8.0_171, Oracle Corporation
::: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.171-4.b10.fc28.x86_64/jre
::: Linux, amd64, 4.16.12-300.fc28.x86_64
::: user.home @ /home/paulo
::: user.dir @ /home/paulo/Documents
::: CF @ [none]
\end{codebox}

\begin{messagebox}{A privacy note}{araracolour}{\icok}{white}
\setlength{\parskip}{1em}
I understand that the previous entries containing information about the underlying operating system might pose as a privacy threat to some users. However, it is worth noting that \arara\ does not share any sensitive information about your system, the entries are listed in the log file for debugging purposes only, locally in your computer.

From experience, these entries greatly help our users to track down errors in the execution, as well as learning more about the underlying operating system. However, be mindful of sharing your log file! Since the log file contains structured sections, it is highly advisable to selectively choose the ones relevant to the current discussion.
\end{messagebox}

It is important to observe that localized messages are also applied to the log file. If a language other than English is selected, either through the \opbox{{-}language} command line option or the equivalent key in the configuration file, the logging framework will honour the current setting and entries will be available in the specified language. Having a log file on your own language might mitigate the traumatic experience of error tracking for \TeX\ newbies.

\section{Directive extraction}
\label{sec:directiveextraction}

The following section in the log file refers to file information and directive extration. First, as the terminal output counterpart, the tool will display details about the file being processed, including size and modification status:

\begin{codebox}{Log file}{teal}{\icnote}{white}
Processing 'doc12.tex' (size: 74 bytes, last modified:
06/02/2018 05:36:40), please wait.
\end{codebox}

The next entries refer to finding potential directive patterns in the code, including multiline support. All matching patterns contain the corresponding line numbers. Note that these numbers might refer to incorrect lines in the code when the \opbox{{-}preamble} command line option is used.

\begin{codebox}{Log file}{teal}{\icnote}{white}
I found a potential pattern in line 1: pdftex
I found a potential pattern in line 2: clean: { extensions: [ log ] }
\end{codebox}

When all matching patterns are collected from the code in the previous phase, \arara\ composes the directives accordingly, including potential parameters and conditionals. Observe that all directives have an associated list of line numbers from which they were originally composed. This phase is known as \emph{directive extraction}.

\begin{codebox}{Log file}{teal}{\icnote}{white}
I found a potential directive: Directive: { identifier: pdftex,
parameters: {}, conditional: { NONE }, lines: [1] }
I found a potential directive: Directive: { identifier: clean,
parameters: {extensions=[log]}, conditional: { NONE }, lines: [2] }
\end{codebox}

In this phase, directives are correctly extracted and composed, but yet to be validated regarding invalid or reserved parameter keys. The tool then proceeds to validate parameters and normalize such directives.

\section{Directive normalization}
\label{sec:directivenormalization}

% TODO fix reference
Once all directives are properly composed, the tool checks for potential inconsistences, such as invalid or reserved parameter keys. Then all directives are validated and internally mapped with special parameters, as previously described in Section~\ref{foo}, on page~\pageref{foo}.

\begin{codebox}{Log file}{teal}{\icnote}{white}
All directives were validated. We are good to go.
\end{codebox}

After validation, all directives are listed in a special section in the log file, including potential parameters and conditionals. This phase is known as \emph{directive normalization}. Note that the special parameters are already included, regardless of the directive type.  This particular section can be used specially for debugging purposes, since it contains all details regarding directives.

\begin{codebox}{Log file}{teal}{\icnote}{white}
-------------------------- DIRECTIVES ---------------------------
Directive: { identifier: pdftex, parameters:
{reference=/home/paulo/Documents/doc12.tex,
file=doc12.tex}, conditional: { NONE }, lines: [1] }
Directive: { identifier: clean, parameters: {extensions=[log],
file=doc12.tex, reference=/home/paulo/Documents/doc12.tex},
conditional: { NONE }, lines: [2] }
-----------------------------------------------------------------
\end{codebox}

Note, however, that potential errors in directive conditionals, as well as similar inconsistencies in the corresponding rules, can only be caught at runtime. The next phase covers proper interpretation based on the provided directives.

\section{Rule interpretation}
\label{sec:ruleinterpretation}

Once directives are normalized, \arara\ proceeds to interpret 

%\begin{codebox}{Terminal}{teal}{\icnote}{white}
%\end{codebox}

%\begin{ncodebox}{Source file}{teal}{\icnote}{white}{}
%\end{ncodebox}

%\begin{messagebox}{}{araracolour}{\icok}{white}
%\end{messagebox}
